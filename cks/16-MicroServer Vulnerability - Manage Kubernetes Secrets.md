### Secrets
##### Get secrets 
- kubectl exec pod -- env | grep [Secrets]
- kubectl exec pod -- mouunt | grep [Screts]
##### Hack Screts in Container Runtime
- crictl ps or crictl inspect ContainerID | vim - -> Find the PID
- ps aux | grep PID -> Check Secrets
ls /proc/PID/root
find /proc/PID/root/etc/Secret
cat /proc/PID/root/etc/Secret/User
crictll inspect ContainerID | grep Secret-Key
##### Hack Secrets in ETCD
- ETCDCTL_API=3 etcdctl endpoint health -> Chack ETCD healthy
- Use apiserver yaml file Settings to access to ETCD
cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd
ETCDCTL_API=3 etcdctl --cacert etcd-ca.crt--cert etcd-client.crt --key etcd-client.key endpoint health
※ETCD default Endpoint -> 127.0.0.1:2379 
ETCDCTL_API=3 etcdctl --cacert etcd-ca.crt--cert etcd-client.crt --key etcd-client.key get /regitry/secrets/Namespace/Secret

##### ETCD Encrypt
- Secrets is stored in ETCD unencrtpted and can be readed in plain text
- Use EncryptionConfiguration ecncryts all Secrets in ETCD  
Create a EncryptionConfiguration file and pass it to apiserver
```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: key1
              secret: <BASE 64 ENCODED SECRET>
      - identity: {}　# <-- read secrets witout encryption
```
Edit the manifest for the kube-apiserver static pod: /etc/kubernetes/manifests/kube-apiserver.yaml similarly to this:  
```yaml
 apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 10.10.30.4:6443
  creationTimestamp: null
  labels:
    component: kube-apiserver
    tier: control-plane
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    ...
    - --encryption-provider-config=/etc/kubernetes/enc/enc.yaml  # <-- add this line
    volumeMounts:
    ...
    - name: enc                           # <-- add this line
      mountPath: /etc/kubernetes/enc      # <-- add this line
      readonly: true                      # <-- add this line
    ...
  volumes:
  ...
  - name: enc                             # <-- add this line
    hostPath:                             # <-- add this line
      path: /etc/kubernetes/enc           # <-- add this line
      type: DirectoryOrCreate             # <-- add this line
  ...
```
Recreate all secrets
```concole
kubectl get secret -A - o yaml | kubectl replace -f -
```
Comment out the identity
```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: key1
              secret: <BASE 64 ENCODED SECRET>
    #   - identity: {}　# <-- read secrets witout encryption
```


